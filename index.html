<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>index</title>
		<link rel="stylesheet" href="style/style.css">
	</head>
	<body>
<!-- 		<div class="login">
			
		</div>
		<div class="main">
			<div>单人模式</div>
			<div>对战模式</div>
			<div>排行榜</div>
		</div> -->
		<div class="game">
			<canvas class="main fl"></canvas>
			<div class="side fr">
				<div>next</div>
				<canvas class="next"></canvas>
				<div class="score-box">
					<div class="tag fl">score</div>
					<div class="score fr">0</div>
					<div class="cf"></div>				
				</div>
			</div>
			<div class="cf"></div>
		</div>		
		<script>
			var mCanvas = document.querySelector('.main');
			var nCanvas = document.querySelector('.next');
			/*获取游戏画布的实例对象canvas*/
			/*获取2d绘图上下文context, context是一个包含了各种表示绘图状态的属性和方法的对象*/

			var CANVAS_WIDTH = 286;
			var CANVAS_HEIGHT = 520;
			var BLOCK_WIDTH = 26;

			var GRID_ROW = CANVAS_HEIGHT/BLOCK_WIDTH;
			var GRID_COL = CANVAS_WIDTH/BLOCK_WIDTH;

			var BLACK = '#001133';

			mCanvas.setAttribute('width', CANVAS_WIDTH);
			mCanvas.setAttribute('height', CANVAS_HEIGHT);

			nCanvas.setAttribute('width', BLOCK_WIDTH*4);
			nCanvas.setAttribute('height', BLOCK_WIDTH*4);

			function newMatrix(row, col) {
				return new Array(row).join(' ').split(' ').map(function () {
					return new Array(col).join(' ').split(' ').map(function () {
						return 0;
					});
				});
			}

			function copyMatrix(matrix) {
				var tempMatrix = newMatrix(matrix.length, matrix[0].length);
				matrix.forEach(function (item, i) {
					item.forEach(function (item, j) {
						tempMatrix[i][j] = matrix[i][j];
					});
				});

				return tempMatrix;
			}

			function printMatrix(matrix) {
				matrix.forEach(function (item, i) {
					var line = '';
					item.forEach(function (item, j) {
						line += item + ' ';
					});
					console.log(line);
				});
			}

			function Grid(row, col) {
				this.oy = 4;
				this.tempMatrix = newMatrix(this.oy + row, col);
				this.matrix = newMatrix(this.oy + row, col);
				this.row = this.oy + row;
				this.col = col;
			}

			Grid.prototype.check = function (shape) {
				var gm = this.matrix;
				var sm = shape.matrix;

				var sx = shape.x;
				var sy = this.oy + shape.y;
				var sc = shape.getCol();
				var sr = shape.getRow();
			
				if(sx < 0 || sx + sc - 1 > this.col - 1) {
					console.log(new Date() + ' 水平方向越界');
					return false;
				}
							
				if(sy < 0 || sy + sr - 1 > this.row - 1) {
					console.log(new Date() + ' 垂直方向越界');
					return false;
				}

				for(var i = 0; i < sr; i++) {
					for(var j = 0; j < sc; j++) {		
						if(gm[sy + i][sx + j] + sm[i][j] > 1) {
							console.log(new Date() + ' 重叠');
							return false;
						}							
					}					
				}

				return true;
			};

			Grid.prototype.update = function (shape) {
				this.tempMatrix = copyMatrix(this.matrix);

				var gtm = this.tempMatrix;
				var sm = shape.matrix;

				var sx = shape.x;
				var sy = this.oy + shape.y;
				var sc = shape.getCol();
				var sr = shape.getRow();

				for(var i = 0; i < sr; i++)
					for(var j = 0; j < sc; j++)
						gtm[sy + i][sx + j] += sm[i][j];	
			};

			Grid.prototype.save = function () {
				this.matrix = copyMatrix(this.tempMatrix);				
			};

			function Shape(type, color) {
				switch (type) {
					case 'i':
						this.matrix = [[1], [1], [1], [1]];
						break;
					case 'j':
						this.matrix = [
							[0, 1],
							[0, 1],
							[1, 1]
						];
						break;
					case 'l':
						this.matrix = [
							[1, 0],
							[1, 0],
							[1, 1]
						];						
						break;
					case 'o':
						this.matrix = [
							[1, 1],
							[1, 1]
						];	
						break;
					case 's':
						this.matrix = [
							[0, 1, 1],
							[1, 1, 0]
						];
						break;
					case 'z':
						this.matrix = [
							[1, 1, 0],
							[0, 1, 1]
						];
						break;
					case 't':
						this.matrix = [
							[1, 1, 1],
							[0, 1, 0]
						];
						break;
				}
				this.color = color;
				this.lastMatrix = copyMatrix(this.matrix);

				this.x = Math.floor((GRID_COL - this.getCol())/2);
				this.lastX = this.x;
				this.y = -1*this.matrix.length;
				this.lastY = this.y;

				console.log('相对坐标: ' + this.y);
			}

			Shape.types = ['i', 'j', 'l', 'o', 's', 'z', 't'];
			Shape.colors = ['red', 'yellow', 'green', 'blue'];

			Shape.prototype.getRow = function () {
				return this.matrix.length;
			};

			Shape.prototype.getCol = function () {
				return this.matrix[0].length;
			};

			Shape.prototype.rotate = function (flag) {
				this.lastMatrix = copyMatrix(this.matrix);
				var matrixRotated = [];
				
				var row = this.matrix.length;
				var col = this.matrix[0].length;
				var matrixRotated = newMatrix(col, row);

				for(var i = 0; i < row; i++)
					for(var j = 0; j < col; j++)
						if(flag == 1)
							matrixRotated[j][row - 1 - i] = this.matrix[i][j];
						else
							matrixRotated[col - 1 - j][i] = this.matrix[i][j];
			
				this.matrix = matrixRotated;
				return this.matrix;				
			};

			Shape.prototype.move = function (direction) {
				switch (direction) {
					case 0:
						this.lastX = this.x;
						this.x = this.x - 1;
						break;
					case 2:
						this.lastX = this.x;
						this.x = this.x + 1;
						break;
					case 3:
						this.lastY = this.y;
						this.y = this.y + 1;
						break;
				}
			};

			Shape.prototype.goBack = function (keyCode) {
				if(keyCode == 37 || keyCode == 39)
					this.x = this.lastX;
				else if(keyCode == 40)
					this.y = this.lastY;
				else if(keyCode == 38)
					this.matrix = copyMatrix(this.lastMatrix);			
			};

			function Game() {
				this.currentShape = null;
				this.nextShape = null;
				this.grid = new Grid(GRID_ROW, GRID_COL);
				this.timer = null;
				this.score = 0;
			}

			Game.prototype.randomShape = function () {
				var rn1 = Math.floor(Math.random()*Shape.types.length);
				var rt = Shape.types[rn1];
				var rn2 = Math.floor(Math.random()*Shape.colors.length);
				var rc = Shape.colors[rn2];

				return new Shape(rt, rc);
			}

			Game.prototype.next = function () {
				this.currentShape = this.nextShape;
				this.nextShape = new this.randomShape();
			};

			Game.prototype.ctrl = function (keyCode) {
				if(keyCode == 37 || keyCode == 39 || keyCode == 40)
					this.currentShape.move(keyCode - 37);
				else if(keyCode == 38)
					this.currentShape.rotate();
				else if(keyCode == 8)
					this.pause();

				if(this.grid.check(this.currentShape))
					this.grid.update(this.currentShape);
				else {
					this.currentShape.goBack(keyCode);

					if(keyCode == 40) {
						var isOver = false;
						for(var i = 0; i < this.grid.tempMatrix[0].length; i++)
							if(this.grid.tempMatrix[0][i] == 1) {
								isOver = true;
								break;
							}
								
						if(isOver)
							this.end();					
						else {
							var gtm = this.grid.tempMatrix;
							var clearLines = 0;

							for(var i = 0; i < gtm.length; i++) {
								var canClear = true;
								for(var j = 0; j < gtm[i].length; j++)
									canClear = canClear && gtm[i][j] == 1;
								if(canClear) {
									for(var j = 0; j < gtm[i].length; j++)
										gtm[i][j] = 0;
									clearLines++;
									for(var k = i; k > 0; k--)
										gtm[k] = gtm[k - 1];
								}
							}

							while(clearLines != 0)
								this.score += clearLines--;

							this.grid.save();
							this.next();							
						}
					}
				}

				game.paint();
			}

			Game.prototype.fall = function () {
				this.ctrl(40);				
			};

			Game.prototype.start = function () {
				var game = this;
				game.currentShape = new this.randomShape();
				game.nextShape = new this.randomShape();
				game.fall();

				game.timer = setInterval(function () {				
					game.fall();
				}, 1000);				
			};

			[[1,2,3], [4,5,6]].forEach(function (item) {
				item.forEach(function (item) {
					item = 0;
				})
			})

			Game.prototype.pause = function () {
				clearInterval(this.timer);
				alert('暂停');
			};

			Game.prototype.end = function () {
				clearInterval(this.timer);
				alert('Game Over');
			};

			Game.prototype.paint = function () {
				var oy = this.grid.oy;
				var matrix = this.grid.tempMatrix.slice(oy);

				mContext.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

				mContext.save();
				mContext.fillStyle = '#becfea';
				mContext.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
				mContext.restore();
				
				matrix.forEach(function (item, i) {
					if(i >= oy) {
						item.forEach(function (item, j) {
							mContext.save();
							if(item == 0)
								mContext.fillStyle = '#becfea';
							else if(item == 1)
								mContext.fillStyle = 'red';							
							else
								alert('非法值: ' + item);
							mContext.fillRect(j*BLOCK_WIDTH, (i - oy)*BLOCK_WIDTH, BLOCK_WIDTH, BLOCK_WIDTH);							
							mContext.restore();
						});						
					}
				});

				this.nextShape.matrix.forEach(function (item, i) {
					item.forEach(function (item, j) {
						nContext.save();
						if(item == 0)
							nContext.fillStyle = '#becfea';
						else
							nContext.fillStyle = 'red';		
						nContext.fillRect(j*BLOCK_WIDTH, i*BLOCK_WIDTH, BLOCK_WIDTH, BLOCK_WIDTH);
						nContext.restore();
					})
				})

				document.querySelector('.score').innerHTML = this.score;				
			};

			function Paint(canvas) {
				this.context = canvas.getContext('2d');
			}

			Paint.prototype.drawMatrix = function (matrix) {
				var context = this.context;
				var width = matrix.length[0].length*BLOCK_WIDTH;
				var height = matrix.length*BLOCK_WIDTH;

				context.clearRect(0, 0, width, height);
				matrix.forEach(function (item, i) {
					item.forEach(function (item, j) {
						context.save();

						if(item == 0)
							context.fillStyle = '#becfea';
						else
							context.fillStyle = 'red';
						context.strokeStyle = '#232323';
						context.rect(j*BLOCK_WIDTH, i*BLOCK_WIDTH, BLOCK_WIDTH, BLOCK_WIDTH);
						context.fill();
						context.stroke();

						context.restore();
					})
				})
			}

			var game = new Game();

			game.start();

			document.onkeypress = function (e) {
				game.ctrl(e.keyCode);
			};
		</script>
	</body>
</html>